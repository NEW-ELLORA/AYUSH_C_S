<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SGPA / CGPA Multi-Student Analyzer (Web + Supabase)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1620; --card:#111a25; --text:#e9f2ff; --muted:#9fb3c8;
    --aqua:#00ffe5; --violet:#b784ff; --red:#ff5d7a; --green:#22c55e; --blue:#3b82f6;
  }
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--text);
    background: radial-gradient(1200px 600px at -15% 10%, rgba(0,255,229,.07), transparent 60%),
                radial-gradient(900px 500px at 110% -10%, rgba(183,132,255,.07), transparent 60%),
                linear-gradient(180deg, #071019, #0b0f14 35%, #0b0f14 100%);
  }
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  .glass{background:rgba(16,24,34,.8); border:1px solid rgba(0,255,229,.18); border-radius:14px; box-shadow:0 0 30px rgba(0,255,229,.06), inset 0 0 30px rgba(183,132,255,.05); backdrop-filter: blur(8px);}
  .row{display:flex; gap:16px; align-items:center}
  .btn{border:1px solid rgba(255,255,255,.14); background:#13202f; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn.primary{background:linear-gradient(90deg, var(--blue), #7c3aed); border-color:rgba(124,58,237,.45)}
  .btn.danger{background:#2a1220; border-color:#661d35}
  .btn.ghost{background:transparent}
  input,select{background:#0e1723; color:#fff; border:1px solid rgba(255,255,255,.14); padding:9px 10px; border-radius:10px; outline:none}
  table{width:100%; border-collapse:collapse}
  th,td{border-bottom:1px solid rgba(255,255,255,.08); padding:8px}
  th{text-align:left; color:#d6e4ff; font-weight:600}
  .h1{font-size:28px; font-weight:800; letter-spacing:.2px; color:var(--aqua); text-shadow:0 0 10px rgba(0,255,229,.5), 0 0 22px rgba(183,132,255,.3)}
  .muted{color:var(--muted)}
  .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:14px}
  .grid{display:grid; gap:16px}
  .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .right{display:flex; gap:10px; align-items:center}
  .chip{display:inline-block; padding:4px 8px; border-radius:999px; background:#17314b; border:1px solid rgba(255,255,255,.12)}
  .auth{max-width:620px; margin:40px auto; padding:24px}
  .center{text-align:center}
  .mb16{margin-bottom:16px}
  .mb8{margin-bottom:8px}
  .mt8{margin-top:8px}
  .mt24{margin-top:24px}
  .hide{display:none}
  .warn{color:#ffbf69}
  /* Chart sizing fix */
  #overviewChart{width:100% !important; max-height:220px;}
  @media (min-width:1100px){ #overviewChart{max-height:260px;} }

  /* small note icon */
  .note-icon{cursor:pointer; user-select:none}
  .note-has{color:#facc15}
</style>
</head>
<body>

<div class="wrap">
  <div class="row" style="justify-content:space-between; margin-bottom:18px">
    <div class="row">
      <div class="h1">ðŸ“Š SGPA / CGPA Analyzer</div>
      <span class="chip">Web + Supabase</span>
    </div>
    <div class="right">
      <button id="btnLogout" class="btn danger">Logout</button>
    </div>
  </div>

  <!-- Auth / profile controls -->
  <div id="authPanel" class="glass auth">
    <div class="center mb16">
      <div style="font-size:22px; font-weight:800; color:var(--aqua)">Profiles</div>
      <div class="muted">Create, load, or continue as guest. Data is stored in Supabase for accounts and in your browser for guests.</div>
      <div class="warn mt8" id="sbWarn"></div>
    </div>
    <div class="grid g-2">
      <div class="card">
        <div class="mb8" style="font-weight:700">Create Account</div>
        <input id="regUser" placeholder="Username" class="mb8" />
        <input id="regPass" type="password" placeholder="Password" class="mb8" />
        <button id="btnRegister" class="btn primary">Create</button>
      </div>
      <div class="card">
        <div class="mb8" style="font-weight:700">Login</div>
        <input id="logUser" placeholder="Username" class="mb8" />
        <input id="logPass" type="password" placeholder="Password" class="mb8" />
        <button id="btnLogin" class="btn primary">Login</button>
        <button id="btnGuest" class="btn mt8">Continue as Guest</button>
      </div>
    </div>
  </div>

  <!-- Main app -->
  <div id="app" class="hide">
    <!-- Top bar -->
    <div class="glass card mb16 row" style="justify-content:space-between">
      <div class="row">
        <div id="who" class="chip">Welcome, Guest</div>
        <div id="cgpaBadge" class="chip">CGPA: 0.00</div>
      </div>
      <div class="right">
        <select id="studentSelect" style="display:none"></select>
      </div>
    </div>

    <!-- Overview & goal -->
    <div class="grid g-3 mb16">
      <div class="glass card">
        <div style="font-weight:700" class="mb8">CGPA progression</div>
        <canvas id="overviewChart"></canvas>
      </div>
      <div class="glass card">
        <div style="font-weight:700" class="mb8">Goal planner</div>
        <div class="grid g-2">
          <div>
            <div class="muted mb8">Prev CGPA</div>
            <input id="prevCGPA" value="0" inputmode="decimal" />
          </div>
          <!-- credits removed -->
          <div>
            <div class="muted mb8">Goal CGPA</div>
            <input id="goalCGPA" value="9" inputmode="decimal" />
          </div>
        </div>
        <div class="row mt8">
          <button id="btnPlan" class="btn primary">Plan Goal</button>
          <!-- NEW: per-subject prediction button -->
          <button id="btnPredict" class="btn">Predict per-subject</button>
        </div>
      </div>
      <div class="glass card">
        <div style="font-weight:700" class="mb8">Analytics</div>
        <div id="analytics" style="white-space:pre-wrap; font-family:ui-monospace,Consolas,monaco; font-size:13px; line-height:1.35; max-height:220px; overflow:auto"></div>
      </div>
    </div>

    <!-- Semesters -->
    <div class="glass card mb16">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:800">Semesters</div>
        <div class="right">
          <button id="btnAddSem" class="btn">+ Add Semester</button>
          <button id="btnChartsAll" class="btn">Open Charts (all)</button>
        </div>
      </div>
      <div id="semesters"></div>
    </div>
  </div>
</div>

<script>
(function(){
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
  } else {
    initApp();
  }
  function initApp(){

/* ============ Supabase config (yours) ============ */
const SUPABASE_URL = "https://xnmdstozrzxfgulfkdoh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhubWRzdG96cnp4Zmd1bGZrZG9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTg2MTgsImV4cCI6MjA3NDczNDYxOH0.NaV-B-kMGB9wWnhB8fzUGg7zh3KXZqCSJSVSNYZ4ZwU";
let supabase = null;
try {
  if (SUPABASE_URL && SUPABASE_URL !== "YOUR_SUPABASE_URL") {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
} catch(e) { console.warn("Supabase init error", e); }
const sbWarn = document.getElementById('sbWarn');
if (!supabase) sbWarn.textContent = 'Supabase is not configured. Using local storage only (Guest mode).';

/* ============ Helpers ============ */
const DBKEY='sgpa_web_db_v2', AUTOSAVE='__autosave__';
const loadLocal=()=>{try{const raw=localStorage.getItem(DBKEY); if(!raw)return{students:{}}; const db=JSON.parse(raw); db.students||={}; return db;}catch{return{students:{}};}}; 
const saveLocal=(db)=>localStorage.setItem(DBKEY,JSON.stringify(db));
function downloadFile(name,content,type){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:type||'text/plain'})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

/* ============ Math/Domain ============ */
const SEE_DIV=2, GRADE_DIV=10, CIE_MAX=50;
/* CIE is MANUAL now (0â€“50). */
const cie=(s)=>Math.min(CIE_MAX, Number(s.cie)||0);
const seeScaled=(s)=>s.see/SEE_DIV;
const finalMarks=(s)=>Math.max(0, cie(s)+seeScaled(s));
const gradePoint=(s)=>finalMarks(s)/GRADE_DIV;
/* SGPA = average of GP across included subjects (no credits) */
const sgpa=(subjects)=>{const inc=subjects.filter(s=>s.included); const n=inc.length; if(!n)return 0; const sum=inc.reduce((a,b)=>a+gradePoint(b),0); return sum/n;};
const pearson=(x,y)=>{if(x.length!==y.length||x.length<2)return 0; const n=x.length; const mx=x.reduce((a,b)=>a+b,0)/n, my=y.reduce((a,b)=>a+b,0)/n; let num=0,dxs=0,dys=0; for(let i=0;i<n;i++){const dx=x[i]-mx, dy=y[i]-my; num+=dx*dy; dxs+=dx*dx; dys+=dy*dy;} const den=Math.sqrt(dxs)*Math.sqrt(dys); return den?num/den:0;};
const linReg=(x,y)=>{const n=x.length; if(n<2)return{m:0,b:y.reduce((a,b)=>a+b,0)/n||0}; const mx=x.reduce((a,b)=>a+b,0)/n, my=y.reduce((a,b)=>a+b,0)/n; let num=0,den=0; for(let i=0;i<n;i++){num+=(x[i]-mx)*(y[i]-my); den+=(x[i]-mx)**2;} const m=den?num/den:0; return {m,b:my-m*mx};};

/* ============ App state ============ */
let currentUser=null, currentStudent=null, students={}, charts=[], userSession=null;
const blankSubject=(name='Subject')=>({name, mse1:0, mse2:0, task1:0, task2:0, task3:0, cie:0, see:0, included:true, note:''});
const blankStudent=(username='__new__')=>({username, created:new Date().toISOString(), prevCGPA:0, semesters:[[blankSubject()]]});

/* ============ Supabase CRUD ============ */
const EMAIL_SUFFIX='@sgpa-demo.dev';
const unameToEmail=(u)=> u.includes('@') ? u : (u + EMAIL_SUFFIX);
async function sbRegister(username,password){
  if(!supabase)throw new Error('Supabase not configured');
  const email=unameToEmail(username);
  const {data,error}=await supabase.auth.signUp({email,password,options:{emailRedirectTo:location.origin}});
  if(error)throw error;
  const user=data.user;
  if(user){ await supabase.from('profiles').upsert({id:user.id, username}); }
  return data;
}
async function sbLogin(username,password){
  if(!supabase)throw new Error('Supabase not configured');
  const email=unameToEmail(username);
  const {data,error}=await supabase.auth.signInWithPassword({email,password});
  if(error)throw error;
  userSession=data.session;
  return data;
}
async function sbLogout(){ if(supabase){ await supabase.auth.signOut(); userSession=null; } }
async function sbLoadStudents(){ if(!supabase||!userSession)return{}; const {data,error}=await supabase.from('students').select('name, data').order('created_at'); if(error)throw error; const out={}; (data||[]).forEach(r=>out[r.name]=r.data); return out; }
async function sbSaveStudent(name,rec){ if(!supabase||!userSession)return; const {error}=await supabase.from('students').upsert({name,data:rec}); if(error)throw error; }

/* ============ UI wiring ============ */
const $=(id)=>document.getElementById(id);
const authPanel=$('authPanel'), appPanel=$('app');

$('btnRegister').onclick=async()=>{
  const u=$('regUser').value.trim(), p=$('regPass').value;
  if(!u||!p){ alert('Enter username & password'); return; }
  try{ if(!supabase)throw new Error('Supabase not configured'); await sbRegister(u,p); alert('Registered. You can login now.'); }
  catch(e){ alert('Register error: '+(e.message||e)); }
};
$('btnLogin').onclick=async()=>{
  const u=$('logUser').value.trim(), p=$('logPass').value;
  try{
    if(!supabase)throw new Error('Supabase not configured');
    await sbLogin(u,p);
    currentUser=u;
    students=await sbLoadStudents();
    if(!Object.keys(students).length){ students[u]=blankStudent(u); await sbSaveStudent(u,students[u]); }
    currentStudent=Object.keys(students)[0];
    startApp();
  }catch(e){ alert('Login error: '+(e.message||e)); }
};
$('btnGuest').onclick=()=>{ currentUser='GUEST'; const db=loadLocal(); students=db.students||{}; if(!students[AUTOSAVE])students[AUTOSAVE]=blankStudent('guest'); currentStudent=AUTOSAVE; startApp(); };
$('btnLogout').onclick=async()=>{ try{await persist();}catch{} await sbLogout(); appPanel.classList.add('hide'); authPanel.classList.remove('hide'); };

/* ============ Render ============ */
function startApp(){ authPanel.classList.add('hide'); appPanel.classList.remove('hide'); renderStudentsList(); renderAll(); }
function renderStudentsList(){ const sel=$('studentSelect'); if(!sel) return; sel.innerHTML=''; Object.keys(students).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); }); sel.value=currentStudent||''; sel.onchange=()=>{ currentStudent=sel.value; renderAll(); }; }
function renderAll(){
  charts.forEach(c=>{ try{c.destroy();}catch{} }); charts=[];
  const rec=students[currentStudent]; if(!rec)return;
  $('who').textContent='Welcome, '+(currentUser||'Guest');
  $('prevCGPA').value=rec.prevCGPA??0;
  const host=$('semesters'); host.innerHTML='';
  rec.semesters.forEach((sem,idx)=>host.appendChild(renderSemester(sem,idx)));
  updateCGPAWidgets(); drawOverview(); persist();
}
function renderSemester(sem,semIndex){
  const card=document.createElement('div'); card.className='card mt24';
  const header=document.createElement('div'); header.className='row'; header.style.justifyContent='space-between';
  const hLeft=document.createElement('div'); hLeft.innerHTML='<b>Semester '+(semIndex+1)+'</b> <span class="status" id="sgpa-'+semIndex+'">SGPA: '+sgpa(sem).toFixed(3)+'</span>';
  const hRight=document.createElement('div'); hRight.className='right';
  const btnAdd=Object.assign(document.createElement('button'),{className:'btn',textContent:'+ Subject'});
  const btnCSV=Object.assign(document.createElement('button'),{className:'btn',textContent:'Export CSV'});
  const btnCharts=Object.assign(document.createElement('button'),{className:'btn',textContent:'Open Charts'});
  const btnRemoveSem=Object.assign(document.createElement('button'),{className:'btn danger',textContent:'Remove Semester'});
  btnRemoveSem.onclick=()=>{ if(confirm('Remove this semester?')){ const rec=students[currentStudent]; rec.semesters.splice(semIndex,1); renderAll(); } };
  hRight.append(btnAdd,btnCSV,btnCharts,btnRemoveSem); header.append(hLeft,hRight);
  const table=document.createElement('table');
  table.innerHTML='<thead><tr><th>Inc</th><th>Subject</th><th>MSE1</th><th>MSE2</th><th>Task1</th><th>Task2</th><th>Task3</th><th>CIE</th><th>SEE</th><th>GP</th><th>Note</th><th>Action</th></tr></thead><tbody id="tbody-'+semIndex+'"></tbody>';
  card.append(header,table);
  const tbody=table.querySelector('tbody');

  const mkCell=(el)=>{const td=document.createElement('td'); td.appendChild(el); return td;};
  /* strict clamped numeric */
  const mkNum=(val,min,max,step,cb)=>{
    const i=Object.assign(document.createElement('input'),{type:'number',value:val,min:min,max:max,step:step,inputMode:'decimal',style:'width:84px'});
    const clamp=(v)=>{ if(Number.isNaN(v)) return min; if(v<min) v=min; if(v>max) v=max; return v; };
    const update=()=>{ let v=parseFloat(i.value); v=clamp(v); i.value=String(v); cb(v); updateCGPAWidgets(); drawOverview(); persist(); };
    i.addEventListener('input',update);
    i.addEventListener('blur',update);
    i.addEventListener('wheel',e=>{ e.preventDefault(); }, {passive:false});
    i.onkeydown=e=>{ if(e.key==='Enter'){ e.preventDefault(); i.blur(); } };
    return i;
  };
  const mkTxt=(val,cb)=>{ const i=Object.assign(document.createElement('input'),{value:val,style:'width:180px'}); i.oninput=()=>{ cb(i.value); persist(); }; i.onkeydown=e=>{ if(e.key==='Enter'){e.preventDefault(); i.blur();} }; i.onblur=()=>refresh(); return i; };

  const renderRows=()=>{ tbody.innerHTML=''; sem.forEach((s,subIndex)=>{ const tr=document.createElement('tr');
    const tdInc=document.createElement('td'); const inc=Object.assign(document.createElement('input'),{type:'checkbox',checked:!!s.included}); inc.onchange=()=>{ s.included=inc.checked; refresh(); }; tdInc.appendChild(inc);

    /* note icon */
    const noteIcon=document.createElement('span');
    noteIcon.textContent='ðŸ“';
    noteIcon.className='note-icon' + (s.note ? ' note-has' : '');
    noteIcon.title = s.note ? s.note : 'Add note';
    noteIcon.onclick=()=>{ const n=prompt('Note for '+(s.name||'Subject'), s.note||''); if(n!==null){ s.note=n; noteIcon.className='note-icon' + (s.note ? ' note-has' : ''); noteIcon.title = s.note || 'Add note'; persist(); } };

    const cells=[
      tdInc,
      mkCell(mkTxt(s.name, v=>s.name=v)),
      mkCell(mkNum(s.mse1,0,20,'0.5', v=>s.mse1=v)),
      mkCell(mkNum(s.mse2,0,20,'0.5', v=>s.mse2=v)),
      mkCell(mkNum(s.task1,0,4,'0.5', v=>s.task1=v)),
      mkCell(mkNum(s.task2,0,4,'0.5', v=>s.task2=v)),
      mkCell(mkNum(s.task3,0,2,'0.5', v=>s.task3=v)),
      /* CIE is editable by user (0â€“50) */
      mkCell(mkNum(s.cie,0,50,'0.5', v=>s.cie=v)),
      mkCell(mkNum(s.see,0,100,'1', v=>s.see=v)),
      mkCell((()=>{ const div=document.createElement('div'); const gp=gradePoint(s); div.textContent=gp.toFixed(2); div.style.fontWeight='700'; div.style.color=gp>=9?'var(--green)':(gp>=7?'#e5e557':'var(--red)'); return div; })()),
      mkCell(noteIcon),
      mkCell((()=>{ const b=Object.assign(document.createElement('button'),{className:'btn danger',textContent:'Remove'}); b.onclick=()=>{ if(confirm('Remove '+s.name+'?')){ sem.splice(subIndex,1); refresh(); } }; return b; })())
    ];
    cells.forEach(c=>tr.appendChild(c)); tbody.appendChild(tr);
  }); };

  const refresh=()=>{ renderRows(); document.getElementById('sgpa-'+semIndex).textContent='SGPA: '+sgpa(sem).toFixed(3); updateCGPAWidgets(); drawOverview(); persist(); };

  btnAdd.onclick=()=>{ sem.push(blankSubject('Subject '+(sem.length+1))); refresh(); };
  /* CSV includes your CIE value */
  btnCSV.onclick=()=>{ const rows=[['Include','Subject','MSE1','MSE2','Task1','Task2','Task3','CIE','SEE','SEE_scaled','Final(100)','GP']]; sem.forEach(s=>rows.push([s.included?'Yes':'No',s.name,s.mse1,s.mse2,s.task1,s.task2,s.task3, cie(s).toFixed(0), s.see, seeScaled(s).toFixed(2), finalMarks(s).toFixed(2), gradePoint(s).toFixed(3)])); downloadFile(students[currentStudent].username+'-sem'+(semIndex+1)+'.csv', rows.map(r=>r.map(v=>{const s=String(v??''); return /[",\n]/.test(s)?'"'+s.replaceAll('"','""')+'"':s;}).join(',')).join('\n'), 'text/csv'); };
  btnCharts.onclick=()=>openChartsForSemester(sem, 'Semester '+(semIndex+1)));

  renderRows();
  return card;
}

function updateCGPAWidgets(){
  const rec=students[currentStudent]; if(!rec)return;
  rec.prevCGPA=Number($('prevCGPA').value)||0;
  /* Average across all included subjects across semesters */
  const all=rec.semesters.flatMap(sem=>sem.filter(s=>s.included));
  const CGPA=all.length? (all.reduce((a,s)=>a+gradePoint(s),0)/all.length) : 0;
  $('cgpaBadge').textContent='CGPA: '+CGPA.toFixed(2);
}

function drawOverview(){
  const rec=students[currentStudent]; if(!rec)return;
  const ctx=$('overviewChart').getContext('2d');
  const existing=charts.find(c=>c.ctx&&c.ctx.canvas===ctx.canvas);
  if(existing){ try{existing.destroy();}catch{} charts=charts.filter(c=>c!==existing); }

  const semSgpas=[];
  rec.semesters.forEach(sem=>{ semSgpas.push(sgpa(sem)); });
  const cum=[]; let total=0; for(let i=0;i<semSgpas.length;i++){ total+=semSgpas[i]; cum.push(total/(i+1)); }

  const grad = ctx.createLinearGradient(0,0,0,260);
  grad.addColorStop(0,'rgba(0,255,229,0.45)');
  grad.addColorStop(1,'rgba(183,132,255,0.05)');

  const chart=new Chart(ctx,{
    type:'line',
    data:{labels:cum.map((_,i)=>'Sem '+(i+1)),
      datasets:[{label:'Cumulative CGPA',data:cum,fill: true,backgroundColor:grad,borderColor:'#00ffe5',tension:.35,pointRadius:3,pointHoverRadius:5}]},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{legend:{labels:{boxWidth:12}}},
      scales:{y:{min:0,max:10,grid:{color:'rgba(255,255,255,.06)'}}, x:{grid:{display:false}}}
    }
  });
  charts.push(chart);
}

function openChartsForSemester(sem, title){
  const win=window.open('','_blank','width=1100,height=700');
  const html = ''
    + '<title>'+title+' Charts</title>'
    + '<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>'
    + '<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"><'+'/script>'
    + '<style>html,body{height:100%;margin:0}*{box-sizing:border-box} .grid{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(2,1fr);gap:14px;height:85vh} canvas{width:100% !important;height:100% !important;}</style>'
    + '<div style="padding:16px; font-family:Inter,system-ui; background:#0b0f14; color:#e9f2ff">'
    + '<div style="font-weight:800; margin-bottom:12px; color:#00ffe5">'+title+' â€” Analytics</div>'
    + '<div class="grid">'
    + '<canvas id="c1"></canvas>'
    + '<canvas id="c2"></canvas>'
    + '<canvas id="c3"></canvas>'
    + '<canvas id="c4"></canvas>'
    + '<canvas id="c5"></canvas>'
    + '<canvas id="c6"></canvas>'
    + '</div></div>';
  win.document.write(html);

  const names=sem.map(s=>s.name);
  const finals=sem.map(s=>finalMarks(s));
  const included=sem.map(s=>!!s.included);
  const cies=sem.map(s=>cie(s));
  const sees=sem.map(s=>s.see);
  const mse1s=sem.map(s=>s.mse1);
  const mse2s=sem.map(s=>s.mse2);
  const tasks=sem.map(s=>s.task1+s.task2+s.task3);
  const seeContrib=sem.map(s=>seeScaled(s));
  const finalsInc=finals.filter((_,i)=>included[i]);
  const namesInc=names.filter((_,i)=>included[i]);

  const w=win; const make=(id,config)=>new w.Chart(w.document.getElementById(id).getContext('2d'),config);
  const commonOpts={responsive:true,maintainAspectRatio:true};

  make('c1',{type:'line',data:{labels:names,datasets:[{label:'Final marks',data:finals,tension:.35}]},options:{...commonOpts,scales:{y:{min:0,max:100}}}});
  make('c2',{type:'bar', data:{labels:names,datasets:[{label:'Final marks',data:finals}]} ,options:{...commonOpts,scales:{y:{min:0,max:100}}}});
  make('c3',{type:'pie', data:{labels:namesInc, datasets:[{data: finalsInc.length?finalsInc:[1]}]} ,options:commonOpts});
  make('c4',{type:'bar', data:{labels:names, datasets:[
      {label:'MSE1',data:mse1s,stack:'s'},
      {label:'MSE2',data:mse2s,stack:'s'},
      {label:'Tasks (T1+T2+T3)',data:tasks,stack:'s'},
      {label:'SEE/2',data:seeContrib,stack:'s'}]},
    options:{...commonOpts,scales:{x:{stacked:true}, y:{stacked:true,min:0,max:100}}}});
  const bins=Math.min(10,Math.max(2,finals.length)), min=0, max=100, width=(max-min)/bins;
  const counts=new Array(bins).fill(0);
  finals.forEach(v=>{const idx=Math.min(bins-1,Math.max(0,Math.floor((v-min)/width))); counts[idx]++;});
  const labels=counts.map((_,i)=>(Math.round(min+i*width))+'-'+(Math.round(min+(i+1)*width)));
  make('c5',{type:'bar', data:{labels:labels, datasets:[{label:'Distribution', data:counts}]}, options:commonOpts});

  const reg=linReg(cies,sees); const xs=[Math.min.apply(null,cies.concat([0])), Math.max.apply(null,cies.concat([100]))]; const ys=xs.map(x=>reg.m*x+reg.b);
  make('c6',{type:'scatter', data:{datasets:[{label:'CIE vs SEE', data: cies.map((x,i)=>({x:x,y:sees[i]}))},{label:'Regression', data: xs.map((x,i)=>({x:x,y:ys[i]})), type:'line'}]}, options:{...commonOpts,scales:{x:{title:{text:'CIE',display:true}}, y:{title:{text:'SEE',display:true}}}}});
  w.document.title=title+' â€” r='+pearson(cies,sees).toFixed(3);
}

function openCharts(){/* legacy no-op */} 
function openAllCharts(){ const rec=students[currentStudent]; if(!rec)return; rec.semesters.forEach((sem,i)=>openChartsForSemester(sem,'Semester '+(i+1))); }

/* ============ Goal Planner (credits removed) ============ */
function planGoal(){
  const rec=students[currentStudent]; if(!rec)return;
  const prevCGPA=Number($('prevCGPA').value)||0, goal=Number($('goalCGPA').value)||0;
  const incSubs=rec.semesters.flatMap(sem=>sem.filter(s=>s.included));
  const curAvg = incSubs.length? (incSubs.reduce((a,s)=>a+gradePoint(s),0)/incSubs.length) : 0;

  const txt=[];
  if(curAvg>=goal){ txt.push('Goal already met with current marks.'); }
  else{
    const needGP = goal;
    txt.push('Uniform required GP across current subjects: '+needGP.toFixed(3)+(needGP>10?' (âš  >10 impossible)':''));
    txt.push('');
    incSubs.forEach(s=>{
      const reqFinal=Math.min(10,needGP)*GRADE_DIV; /* out of 100 */
      const neededSEEraw=Math.max(0, reqFinal-cie(s))*SEE_DIV;
      const needSEE=neededSEEraw> s.see ? Math.min(100, neededSEEraw) : 0;
      txt.push(s.name+': current GP '+gradePoint(s).toFixed(3)+' â†’ need final '+reqFinal.toFixed(2)+' ; SEE needed: '+needSEE.toFixed(2)+' ; Achievable: '+(needGP<=10));
    });
  }
  $('analytics').textContent='Goal planner summary:\nGoal CGPA: '+goal+', Prev CGPA: '+prevCGPA+'\n\n'+txt.join('\n');
}

/* ============ NEW: Per-subject prediction (partial marks) ============ */
function predictNeeds(){
  const rec=students[currentStudent]; if(!rec)return;
  const goal = Number($('goalCGPA').value)||0;
  const needGP = goal;                         // same uniform GP target
  const reqFinal = Math.min(10, needGP) * GRADE_DIV;   // target per-subject final (/100)
  const curSem = rec.semesters[rec.semesters.length-1] || [];
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  // maxes for internals
  const MAX = {mse1:20,mse2:20,task1:4,task2:4,task3:2, cie:50, see:100};

  const lines = [];
  lines.push('Prediction for latest semester to reach per-subject final â‰ˆ '+reqFinal.toFixed(1)+'/100 (goal CGPA '+goal+')');
  lines.push('');

  curSem.forEach((s)=>{
    if(!s.included){ return; }
    // If user provided CIE, predict SEE only
    if((Number(s.cie)||0) > 0){
      const curCIE = clamp(Number(s.cie)||0, 0, 50);
      const needSEEraw = Math.max(0, reqFinal - curCIE) * SEE_DIV; // because SEE/2
      const needSEE = clamp(needSEEraw, 0, 100);
      const ok = needSEE <= 100;
      lines.push(`${s.name||'Subject'}: CIE ${curCIE}/50 fixed â†’ SEE needed â‰ˆ ${needSEE.toFixed(1)}/100 ${ok?'':'(âš ï¸ impossible)'}`);
      return;
    }

    // No CIE yet: compute known internals and remaining capacities
    const cur = {
      mse1: clamp(Number(s.mse1)||0, 0, MAX.mse1),
      mse2: clamp(Number(s.mse2)||0, 0, MAX.mse2),
      task1: clamp(Number(s.task1)||0, 0, MAX.task1),
      task2: clamp(Number(s.task2)||0, 0, MAX.task2),
      task3: clamp(Number(s.task3)||0, 0, MAX.task3),
      see:  clamp(Number(s.see)||0,  0, MAX.see),
    };
    const knownInternal = clamp(cur.mse1+cur.mse2+cur.task1+cur.task2+cur.task3, 0, 50);
    const cap = {
      mse1: MAX.mse1 - cur.mse1,
      mse2: MAX.mse2 - cur.mse2,
      task1: MAX.task1 - cur.task1,
      task2: MAX.task2 - cur.task2,
      task3: MAX.task3 - cur.task3
    };
    const totalCap = Math.max(0, cap.mse1+cap.mse2+cap.task1+cap.task2+cap.task3);

    // how much more internal is needed (before SEE) to reach target
    const needInternal = Math.max(0, reqFinal - knownInternal - (cur.see/SEE_DIV)); // SEE already entered contributes /2
    let suggest = {mse1:cur.mse1, mse2:cur.mse2, task1:cur.task1, task2:cur.task2, task3:cur.task3, see:cur.see};

    let leftInternal = needInternal;

    if(totalCap > 0){
      // distribute proportionally to remaining capacity
      for(const k of ['mse1','mse2','task1','task2','task3']){
        if(leftInternal <= 0) break;
        const share = totalCap ? (cap[k] / totalCap) * needInternal : 0;
        const add = Math.min(cap[k], share);
        suggest[k] = clamp(suggest[k] + add, 0, MAX[k]);
      }
      // recompute achieved internal after distribution
      const newInternal = clamp(suggest.mse1+suggest.mse2+suggest.task1+suggest.task2+suggest.task3, 0, 50);
      leftInternal = Math.max(0, reqFinal - newInternal - (suggest.see/SEE_DIV));
    }

    // whatever is still missing must come from SEE
    if(leftInternal > 0){
      const addSEE = leftInternal * SEE_DIV;
      suggest.see = clamp(suggest.see + addSEE, 0, 100);
    }

    const achievableFinal = Math.min(50, suggest.mse1+suggest.mse2+suggest.task1+suggest.task2+suggest.task3) + (suggest.see/SEE_DIV);
    const ok = achievableFinal + 1e-6 >= reqFinal; // tiny epsilon

    lines.push(
      `${s.name||'Subject'}: target final ${reqFinal.toFixed(1)}/100`+
      ` â†’ aim MSE1â‰ˆ${suggest.mse1.toFixed(1)}/20, MSE2â‰ˆ${suggest.mse2.toFixed(1)}/20,`+
      ` T1â‰ˆ${suggest.task1.toFixed(1)}/4, T2â‰ˆ${suggest.task2.toFixed(1)}/4, T3â‰ˆ${suggest.task3.toFixed(1)}/2,`+
      ` SEEâ‰ˆ${suggest.see.toFixed(1)}/100 ${ok?'':'(âš ï¸ even maxing internals/SEE may fall short)'}`
    );
  });

  $('analytics').textContent = lines.join('\n');
}

/* ============ Persistence ============ */
async function persist(){
  const rec=students[currentStudent]; if(!rec)return;
  if(!userSession){ const db=loadLocal(); db.students=students; db.students[AUTOSAVE]=JSON.parse(JSON.stringify(rec)); saveLocal(db); return; }
  try{ await sbSaveStudent(currentStudent,rec); }catch(e){ console.warn('Supabase save failed',e); }
}
window.addEventListener('beforeunload', persist);

/* top-level controls */
document.getElementById('btnAddSem').onclick=()=>{ const rec=students[currentStudent]; rec.semesters.push([blankSubject()]); renderAll(); };
document.getElementById('btnChartsAll').onclick=()=>openAllCharts();
document.getElementById('btnPlan').onclick=()=>planGoal();
/* NEW: wire up predictor */
document.getElementById('btnPredict').onclick=()=>predictNeeds();

  } // end initApp
})(); // IIFE
</script>
</body>
</html>

